"use strict";(()=>{var e={};e.id=138,e.ids=[138],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},93:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>C,originalPathname:()=>I,patchFetch:()=>D,requestAsyncStorage:()=>$,routeModule:()=>w,serverHooks:()=>A,staticGenerationAsyncStorage:()=>b,staticGenerationBailout:()=>v});var n={};a.r(n),a.d(n,{POST:()=>y,runtime:()=>g});var r=a(5419),s=a(9108),i=a(9678),o=a(8070),l=a(6113),u=a.n(l);let c=(e,t="md5")=>u().createHash(t).update(e).digest("hex"),p=e=>{let t={};for(let a of e.replace(/^Digest\s+/i,"").match(/([a-zA-Z]+)=("[^"]*"|[^,]*)/g)??[]){let[e,n]=a.split("=");t[e]=n?.replace(/^"|"$/g,"")}return t};class h{constructor(e,t,a="MD5"){this.algorithm=a,this.nc=0,this.params={},this.username=e,this.password=t}async getFetch(){if("function"==typeof globalThis.fetch)return globalThis.fetch;throw Error("Fetch API is not available in this runtime.")}buildAuthHeader(e,t){let a=this.params.realm??"",n=this.params.nonce??"",r=this.params.qop??"",s=r.includes("auth")?"auth":r||void 0,i=t.pathname+t.search,o=u().randomBytes(8).toString("hex"),l=(++this.nc).toString(16).padStart(8,"0"),p=this.algorithm.toLowerCase(),h=c(`${this.username}:${a}:${this.password}`,p),d=c(`${e}:${i}`,p),f=s?c(`${h}:${n}:${l}:${o}:${s}:${d}`,p):c(`${h}:${n}:${d}`,p),m=[`username="${this.username}"`,`realm="${a}"`,`nonce="${n}"`,`uri="${i}"`,`response="${f}"`];return this.params.opaque&&m.push(`opaque="${this.params.opaque}"`),s&&(m.push(`qop=${s}`),m.push(`nc=${l}`),m.push(`cnonce="${o}"`)),this.algorithm&&m.push(`algorithm=${this.algorithm}`),`Digest ${m.join(", ")}`}async fetch(e,t={}){let a=new URL(e),n=await this.getFetch(),r=(t.method??"GET").toUpperCase(),s=await n(e,t);if(401!==s.status)return s;let i=s.headers.get("www-authenticate");if(!i)return s;this.params=p(i);let o=this.buildAuthHeader(r,a);return n(e,{...t,headers:{...t.headers??{},Authorization:o}})}}var d=a(970),f=a(7802),m=a(7419);let g="nodejs";async function y(e){let t=await e.json().catch(()=>({})),a="string"==typeof t?.ip?t.ip.trim():"",n="string"==typeof t?.username?t.username:"",r="string"==typeof t?.password?t.password:"",s="string"==typeof t?.name?t.name.trim():"",i=function(e){if(!e)return null;let t=e.trim().toLowerCase();return["ai_box","aibox","ai-box","ai"].includes(t)?"ai_box":["camera","cam"].includes(t)?"camera":null}(t?.deviceType)??"camera";if(!a||!n||!r)return o.Z.json({ok:!1,error:"Missing ip/username/password"},{status:400});let l=new h(n,r,"MD5"),c=[];try{let e=await l.fetch(`http://${a}/LAPI/V1.0/Channels/System/ChannelDetailInfos`,{method:"GET",headers:{Accept:"application/json"}}),t=await e.text();if(!e.ok)throw Error(`Channel query failed (${e.status}): ${t}`);let p=(0,m.D6)(t),h=function(e){if(Array.isArray(e))return e.filter(e=>e&&"object"==typeof e).map(e=>e).map(e=>{let t=e.ChannelID??e.ID??e.channelId??e.Channel,a=e.Name??e.ChannelName??e.Alias??e.DisplayName,n=t?String(t):"0",r="string"==typeof a&&a.trim()?a.trim():`Channel ${n}`;return{id:n,name:r}});let t=e&&"object"==typeof e?e.Response:null,a=t&&"object"==typeof t?t.Data:null;return((0,m.I$)(e,["ChannelDetailInfoList","ChannelDetailInfos","ChannelList","Channels"]).length?(0,m.I$)(e,["ChannelDetailInfoList","ChannelDetailInfos","ChannelList","Channels"]):(0,m.I$)(a,["DetailInfos","ChannelDetailInfos"])).map(e=>{let t=e.ChannelID??e.ID??e.channelId??e.Channel,a=e.Name??e.ChannelName??e.Alias??e.DisplayName,n=t?String(t):"0",r="string"==typeof a&&a.trim()?a.trim():`Channel ${n}`;return{id:n,name:r}})}(p);if(0===h.length)return o.Z.json({ok:!1,error:"No channels returned by camera."},{status:400});let g=await Promise.all(h.map(async e=>{let t=`http://${a}/LAPI/V1.0/Channels/${e.id}/Alarm/Capabilities`;try{let a=await l.fetch(t,{method:"GET",headers:{Accept:"application/json"}}),n=await a.text();if(!a.ok)return c.push(`Capabilities ${e.id} failed (${a.status}).`),{channelId:e.id,features:[],raw:n};let r=(0,m.D6)(n);return{channelId:e.id,features:(0,m.c6)(r??n),raw:r??n}}catch(t){return c.push(`Capabilities ${e.id} error: ${t.message}`),{channelId:e.id,features:[],raw:null}}})),y=(0,f.z)(),w=function(e){let t=u().randomBytes(12),a=function(){let e=process.env.ENCRYPTION_KEY;if(!e)throw Error("ENCRYPTION_KEY is not set.");let t=64===e.length?Buffer.from(e,"hex"):Buffer.from(e,"base64");if(32!==t.length)throw Error("ENCRYPTION_KEY must be 32 bytes (base64 or hex).");return t}(),n=u().createCipheriv("aes-256-gcm",a,t),r=Buffer.concat([n.update(e,"utf8"),n.final()]),s=n.getAuthTag();return{ciphertext:r.toString("base64"),iv:t.toString("base64"),tag:s.toString("base64")}}(r),$=await y.query(`insert into cameras (ip, name, device_type, username, password_ciphertext, password_iv, password_tag)
       values ($1, $2, $3, $4, $5, $6, $7)
       on conflict (ip)
       do update set
         name = excluded.name,
         device_type = excluded.device_type,
         username = excluded.username,
         password_ciphertext = excluded.password_ciphertext,
         password_iv = excluded.password_iv,
         password_tag = excluded.password_tag,
         updated_at = now()
       returning id`,[a,s||null,i,n,w.ciphertext,w.iv,w.tag]),b=$.rows[0]?.id;for(let e of h){let t=g.find(t=>t.channelId===e.id);await y.query(`insert into channels (camera_id, channel_no, name, features, capabilities)
         values ($1, $2, $3, $4, $5)
         on conflict (camera_id, channel_no)
         do update set
           name = excluded.name,
           features = excluded.features,
           capabilities = excluded.capabilities,
           updated_at = now()`,[b,Number(e.id),e.name,t?.features??[],t?.raw??null])}let A=(0,d.yo)(a),C=new Map(A.channels.map(e=>[e.channelId,e.stats])),v=h.map(e=>{let t=g.find(t=>t.channelId===e.id),n=C.get(e.id)??(0,d.Lb)(a,e.id);return{id:e.id,name:e.name,features:t?.features??[],stats:n}}),I=Array.from(new Set(v.flatMap(e=>e.features)));return o.Z.json({ok:!0,ip:a,channels:v,featuresDetected:I,warnings:c})}catch(e){return o.Z.json({ok:!1,error:e.message??"Failed to connect to camera."},{status:500})}}let w=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/camera/connect/route",pathname:"/api/camera/connect",filename:"route",bundlePath:"app/api/camera/connect/route"},resolvedPagePath:"/Users/ameralyasin/Desktop/cam analysis/app/api/camera/connect/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:$,staticGenerationAsyncStorage:b,serverHooks:A,headerHooks:C,staticGenerationBailout:v}=w,I="/api/camera/connect/route";function D(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:b})}},970:(e,t,a)=>{a.d(t,{B$:()=>u,KX:()=>o,Lb:()=>i,sS:()=>l,yo:()=>c});let n=new Map,r=()=>({peopleIn:0,peopleOut:0,faceEvents:0,facesDetected:0,gender:{male:0,female:0,unknown:0},age:{avg:null},glasses:{yes:0,no:0,unknown:0},lastEventAt:null});function s(e){return n.has(e)||n.set(e,{channels:{},lastEventAt:null}),n.get(e)}function i(e,t){let a=s(e);return a.channels[t]||(a.channels[t]=r()),a.channels[t]}function o(e){let{ip:t,channelId:a,objectIn:n,objectOut:r,timestamp:o}=e,l=i(t,a);l.peopleIn+=n,l.peopleOut+=r,l.lastEventAt=o??new Date().toISOString(),s(t).lastEventAt=l.lastEventAt}function l(e,t){let a=i(e,t);a.peopleIn=0,a.peopleOut=0,a.lastEventAt=null}function u(e){let{ip:t,channelId:a,facesDetected:n,timestamp:r}=e,o=i(t,a);o.faceEvents+=1,o.facesDetected+=n,o.lastEventAt=r??new Date().toISOString(),s(t).lastEventAt=o.lastEventAt}function c(e){let t=s(e);return{ip:e,lastEventAt:t.lastEventAt,channels:Object.entries(t.channels).map(([e,t])=>({channelId:e,stats:t}))}}},7802:(e,t,a)=>{a.d(t,{z:()=>s});let n=require("pg"),r=null;function s(){if(!r){let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL is not set.");r=new n.Pool({connectionString:e})}return r}},7419:(e,t,a)=>{function n(e){try{return JSON.parse(e)}catch{let t=e.indexOf("{"),a=e.lastIndexOf("}");if(-1===t||-1===a||a<=t)return null;let n=e.slice(t,a+1).replace(/[\u0000-\u001F\u007F]/g,"");try{return JSON.parse(n)}catch{return null}}}function r(e){let t=e.match(/\b(?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|1?\d?\d)\b/);return t?t[0]:null}function s(e){if(!e)return[];let t=("string"==typeof e?e:JSON.stringify(e)).toLowerCase(),a=[];if((t.includes("peoplecount")||t.includes("line")||t.includes("linecount"))&&a.push("people-count"),(t.includes("face")||t.includes("structure"))&&a.push("face-detection"),t.includes("alarm")&&a.push("alarm"),e&&"object"==typeof e){let t=e.Response,n=t&&"object"==typeof t?t.Data:e.Data;if(n&&"object"==typeof n){let e=(e,t,r)=>{let s=n[e];s&&"object"==typeof s&&1===Number(s[r])&&a.push(t)};e("MotionDetection","motion-detection","IsSupportCfg"),e("TamperDetection","tamper-detection","IsSupportCfg"),e("AudioDetection","audio-detection","SupportCfg"),e("HumanShapeDetection","human-shape-detection","SupportCfg"),e("ConflagrationDetection","conflagration-detection","IsSupportCfg");let t=n.TemperatureDetection;t&&"object"==typeof t&&Number(t.SupportTypeNum)>0&&a.push("temperature-detection"),1===Number(n.SupportConflagration)&&a.push("conflagration"),1===Number(n.SupportSmokingDetection)&&a.push("smoking-detection")}}return Array.from(new Set(a))}function i(e,t){if(!e||"object"!=typeof e)return[];for(let a of t){let t=e[a];if(Array.isArray(t))return t.filter(e=>e&&"object"==typeof e)}return[]}a.d(t,{D6:()=>n,HQ:()=>r,I$:()=>i,c6:()=>s})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[638,206],()=>a(93));module.exports=n})();
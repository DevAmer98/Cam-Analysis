"use strict";(()=>{var e={};e.id=333,e.ids=[333],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9344:(e,t,n)=>{n.r(t),n.d(t,{headerHooks:()=>h,originalPathname:()=>A,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>S,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>v});var r={};n.r(r),n.d(r,{POST:()=>d});var o=n(5419),a=n(9108),i=n(9678),u=n(8070),l=n(970),s=n(7802),c=n(2266),f=n(7413),p=n(7419);async function d(e){let t=await e.text(),n=(0,p.D6)(t);if(!n||"object"!=typeof n)return u.Z.json({ResponseCode:0});let r=(0,f.T)(e,n,t),o=(0,f.d)(n),a=n.StructureInfo,i=a&&"object"==typeof a?a.ObjInfo:null,d=i&&"object"==typeof i?i.FaceInfoList:null,m=Array.isArray(d)?d.length:0;(0,l.B$)({ip:r,channelId:o,facesDetected:m,timestamp:String(n.TimeStamp??"")});let g=(0,s.z)(),y=await g.query(`insert into cameras (ip)
     values ($1)
     on conflict (ip) do update set ip = excluded.ip, updated_at = now()
     returning id`,[r]),S=y.rows[0]?.id;await g.query(`insert into channels (camera_id, channel_no, name)
     values ($1, $2, $3)
     on conflict (camera_id, channel_no) do nothing`,[S,Number(o),`Channel ${o}`]);let h=n.TimeStamp,v="number"==typeof h?new Date(1e3*h).toISOString():"string"==typeof h?new Date(1e3*Number(h)).toISOString():new Date().toISOString(),A=await g.query(`insert into face_events
     (camera_id, channel_no, event_time, faces_detected, raw_payload)
     values ($1, $2, $3, $4, $5)
     returning id`,[S,Number(o),v,m,n]),b=A.rows[0]?.id;if(Array.isArray(d))for(let e of d){if(!e||"object"!=typeof e)continue;let t=e.AttributeInfo&&"object"==typeof e.AttributeInfo?e.AttributeInfo:{};await g.query(`insert into face_attributes
         (face_event_id, face_id, age, age_range, gender, glasses, mask, extra)
         values ($1, $2, $3, $4, $5, $6, $7, $8)`,[b,e.FaceID??null,"number"==typeof t.Age?t.Age:null,"string"==typeof t.AgeRange?t.AgeRange:null,"string"==typeof t.Gender?t.Gender:null,"string"==typeof t.Glasses?t.Glasses:null,"string"==typeof t.Mask?t.Mask:null,t])}return(0,c.t)({type:"face-detection",ip:r,channelId:String(o),timestamp:v}),u.Z.json({ResponseCode:0})}let m=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/LAPI/V1.0/System/Event/Notification/Structure/route",pathname:"/LAPI/V1.0/System/Event/Notification/Structure",filename:"route",bundlePath:"app/LAPI/V1.0/System/Event/Notification/Structure/route"},resolvedPagePath:"/Users/ameralyasin/Desktop/cam analysis/app/LAPI/V1.0/System/Event/Notification/Structure/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:S,headerHooks:h,staticGenerationBailout:v}=m,A="/LAPI/V1.0/System/Event/Notification/Structure/route";function b(){return(0,i.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:y})}},970:(e,t,n)=>{n.d(t,{B$:()=>s,KX:()=>u,Lb:()=>i,sS:()=>l,yo:()=>c});let r=new Map,o=()=>({peopleIn:0,peopleOut:0,faceEvents:0,facesDetected:0,gender:{male:0,female:0,unknown:0},age:{avg:null},glasses:{yes:0,no:0,unknown:0},lastEventAt:null});function a(e){return r.has(e)||r.set(e,{channels:{},lastEventAt:null}),r.get(e)}function i(e,t){let n=a(e);return n.channels[t]||(n.channels[t]=o()),n.channels[t]}function u(e){let{ip:t,channelId:n,objectIn:r,objectOut:o,timestamp:u}=e,l=i(t,n);l.peopleIn+=r,l.peopleOut+=o,l.lastEventAt=u??new Date().toISOString(),a(t).lastEventAt=l.lastEventAt}function l(e,t){let n=i(e,t);n.peopleIn=0,n.peopleOut=0,n.lastEventAt=null}function s(e){let{ip:t,channelId:n,facesDetected:r,timestamp:o}=e,u=i(t,n);u.faceEvents+=1,u.facesDetected+=r,u.lastEventAt=o??new Date().toISOString(),a(t).lastEventAt=u.lastEventAt}function c(e){let t=a(e);return{ip:e,lastEventAt:t.lastEventAt,channels:Object.entries(t.channels).map(([e,t])=>({channelId:e,stats:t}))}}},7802:(e,t,n)=>{n.d(t,{z:()=>a});let r=require("pg"),o=null;function a(){if(!o){let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL is not set.");o=new r.Pool({connectionString:e})}return o}},2266:(e,t,n)=>{n.d(t,{t:()=>o,d:()=>a});let r=new(require("events")).EventEmitter;function o(e){r.emit("camera-event",e)}function a(e){return r.on("camera-event",e),()=>r.off("camera-event",e)}},7413:(e,t,n)=>{n.d(t,{T:()=>o,d:()=>a});var r=n(7419);function o(e,t,n){let o=new URL(e.url).searchParams.get("ip");if(o)return(0,r.HQ)(o)||o;let a=e.headers.get("x-forwarded-for");if(a){let e=a.split(",")[0]?.trim();if(e)return e}let i=e.headers.get("x-real-ip");if(i)return i;if(t&&"object"==typeof t){let e=t.Reference;if("string"==typeof e){let t=(0,r.HQ)(e);if(t)return t}let n=t.SrcName;if("string"==typeof n){let e=(0,r.HQ)(n);if(e)return e}}if(n){let e=(0,r.HQ)(n);if(e)return e}return"unknown"}function a(e){if(!e||"object"!=typeof e)return"0";for(let t of["ChannelID","ChannelId","channelId","Channel"]){let n=e[t];if("number"==typeof n||"string"==typeof n)return String(n)}let t=e.StructureInfo;if(t&&"object"==typeof t){let e=t.ChannelID;if("number"==typeof e||"string"==typeof e)return String(e)}return"0"}},7419:(e,t,n)=>{function r(e){try{return JSON.parse(e)}catch{let t=e.indexOf("{"),n=e.lastIndexOf("}");if(-1===t||-1===n||n<=t)return null;let r=e.slice(t,n+1).replace(/[\u0000-\u001F\u007F]/g,"");try{return JSON.parse(r)}catch{return null}}}function o(e){let t=e.match(/\b(?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|1?\d?\d)\b/);return t?t[0]:null}function a(e){if(!e)return[];let t=("string"==typeof e?e:JSON.stringify(e)).toLowerCase(),n=[];if((t.includes("peoplecount")||t.includes("line")||t.includes("linecount"))&&n.push("people-count"),(t.includes("face")||t.includes("structure"))&&n.push("face-detection"),t.includes("alarm")&&n.push("alarm"),e&&"object"==typeof e){let t=e.Response,r=t&&"object"==typeof t?t.Data:e.Data;if(r&&"object"==typeof r){let e=(e,t,o)=>{let a=r[e];a&&"object"==typeof a&&1===Number(a[o])&&n.push(t)};e("MotionDetection","motion-detection","IsSupportCfg"),e("TamperDetection","tamper-detection","IsSupportCfg"),e("AudioDetection","audio-detection","SupportCfg"),e("HumanShapeDetection","human-shape-detection","SupportCfg"),e("ConflagrationDetection","conflagration-detection","IsSupportCfg");let t=r.TemperatureDetection;t&&"object"==typeof t&&Number(t.SupportTypeNum)>0&&n.push("temperature-detection"),1===Number(r.SupportConflagration)&&n.push("conflagration"),1===Number(r.SupportSmokingDetection)&&n.push("smoking-detection")}}return Array.from(new Set(n))}function i(e,t){if(!e||"object"!=typeof e)return[];for(let n of t){let t=e[n];if(Array.isArray(t))return t.filter(e=>e&&"object"==typeof e)}return[]}n.d(t,{D6:()=>r,HQ:()=>o,I$:()=>i,c6:()=>a})}};var t=require("../../../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[638,206],()=>n(9344));module.exports=r})();
"use strict";(()=>{var e={};e.id=332,e.ids=[332],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4020:(e,t,n)=>{n.r(t),n.d(t,{headerHooks:()=>v,originalPathname:()=>b,patchFetch:()=>A,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>S});var o={};n.r(o),n.d(o,{POST:()=>d});var r=n(5419),i=n(9108),a=n(9678),u=n(8070),l=n(970),s=n(7802),c=n(2266),p=n(7413),f=n(7419);async function d(e){let t=await e.text();console.log("UNV PeopleCount raw payload:",t);let n=(0,f.D6)(t);if(!n||"object"!=typeof n)return u.Z.json({ResponseCode:0});let o=n.Reference,r="string"==typeof o?o.split("/")[0]?.trim():void 0,i=(r?(0,f.HQ)(r)??r:void 0)||(0,p.T)(e,n,t),a=(0,p.d)(n),d=n.LineRuleDataList??n.LineRuleData;if(Array.isArray(d)){let e=(0,s.z)(),t=(0,f.HQ)(i)??i,o=await e.query(`insert into cameras (ip)
       values ($1)
       on conflict (ip) do update set ip = excluded.ip, updated_at = now()
       returning id`,[t]),r=o.rows[0]?.id;for(let o of(await e.query(`insert into channels (camera_id, channel_no, name)
       values ($1, $2, $3)
       on conflict (camera_id, channel_no) do nothing`,[r,Number(a),`Channel ${a}`]),d)){if(!o||"object"!=typeof o)continue;let i=Number(o.ObjectIn??0),u=Number(o.ObjectOut??0),s=Number(o.LineID??0),p=n.TimeStamp,f="number"==typeof p?new Date(1e3*p).toISOString():"string"==typeof p?new Date(1e3*Number(p)).toISOString():new Date().toISOString();(0,l.KX)({ip:t,channelId:a,objectIn:i,objectOut:u,timestamp:f}),await e.query(`insert into people_count_events
         (camera_id, channel_no, line_id, object_in, object_out, event_time, raw_payload)
         values ($1, $2, $3, $4, $5, $6, $7)`,[r,Number(a),s,i,u,f,n]),(0,c.t)({type:"people-count",ip:t,channelId:String(a),timestamp:f})}}return u.Z.json({ResponseCode:0})}let m=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/LAPI/V1.0/System/Event/Notification/PeopleCount/LineRuleData/route",pathname:"/LAPI/V1.0/System/Event/Notification/PeopleCount/LineRuleData",filename:"route",bundlePath:"app/LAPI/V1.0/System/Event/Notification/PeopleCount/LineRuleData/route"},resolvedPagePath:"/Users/ameralyasin/Desktop/cam analysis/app/LAPI/V1.0/System/Event/Notification/PeopleCount/LineRuleData/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:v,staticGenerationBailout:S}=m,b="/LAPI/V1.0/System/Event/Notification/PeopleCount/LineRuleData/route";function A(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},970:(e,t,n)=>{n.d(t,{B$:()=>s,KX:()=>u,Lb:()=>a,sS:()=>l,yo:()=>c});let o=new Map,r=()=>({peopleIn:0,peopleOut:0,faceEvents:0,facesDetected:0,gender:{male:0,female:0,unknown:0},age:{avg:null},glasses:{yes:0,no:0,unknown:0},lastEventAt:null});function i(e){return o.has(e)||o.set(e,{channels:{},lastEventAt:null}),o.get(e)}function a(e,t){let n=i(e);return n.channels[t]||(n.channels[t]=r()),n.channels[t]}function u(e){let{ip:t,channelId:n,objectIn:o,objectOut:r,timestamp:u}=e,l=a(t,n);l.peopleIn+=o,l.peopleOut+=r,l.lastEventAt=u??new Date().toISOString(),i(t).lastEventAt=l.lastEventAt}function l(e,t){let n=a(e,t);n.peopleIn=0,n.peopleOut=0,n.lastEventAt=null}function s(e){let{ip:t,channelId:n,facesDetected:o,timestamp:r}=e,u=a(t,n);u.faceEvents+=1,u.facesDetected+=o,u.lastEventAt=r??new Date().toISOString(),i(t).lastEventAt=u.lastEventAt}function c(e){let t=i(e);return{ip:e,lastEventAt:t.lastEventAt,channels:Object.entries(t.channels).map(([e,t])=>({channelId:e,stats:t}))}}},7802:(e,t,n)=>{n.d(t,{z:()=>i});let o=require("pg"),r=null;function i(){if(!r){let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL is not set.");r=new o.Pool({connectionString:e})}return r}},2266:(e,t,n)=>{n.d(t,{t:()=>r,d:()=>i});let o=new(require("events")).EventEmitter;function r(e){o.emit("camera-event",e)}function i(e){return o.on("camera-event",e),()=>o.off("camera-event",e)}},7413:(e,t,n)=>{n.d(t,{T:()=>r,d:()=>i});var o=n(7419);function r(e,t,n){let r=new URL(e.url).searchParams.get("ip");if(r)return(0,o.HQ)(r)||r;let i=e.headers.get("x-forwarded-for");if(i){let e=i.split(",")[0]?.trim();if(e)return e}let a=e.headers.get("x-real-ip");if(a)return a;if(t&&"object"==typeof t){let e=t.Reference;if("string"==typeof e){let t=(0,o.HQ)(e);if(t)return t}let n=t.SrcName;if("string"==typeof n){let e=(0,o.HQ)(n);if(e)return e}}if(n){let e=(0,o.HQ)(n);if(e)return e}return"unknown"}function i(e){if(!e||"object"!=typeof e)return"0";for(let t of["ChannelID","ChannelId","channelId","Channel"]){let n=e[t];if("number"==typeof n||"string"==typeof n)return String(n)}let t=e.StructureInfo;if(t&&"object"==typeof t){let e=t.ChannelID;if("number"==typeof e||"string"==typeof e)return String(e)}return"0"}},7419:(e,t,n)=>{function o(e){try{return JSON.parse(e)}catch{let t=e.indexOf("{"),n=e.lastIndexOf("}");if(-1===t||-1===n||n<=t)return null;let o=e.slice(t,n+1).replace(/[\u0000-\u001F\u007F]/g,"");try{return JSON.parse(o)}catch{return null}}}function r(e){let t=e.match(/\b(?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|1?\d?\d)\b/);return t?t[0]:null}function i(e){if(!e)return[];let t=("string"==typeof e?e:JSON.stringify(e)).toLowerCase(),n=[];if((t.includes("peoplecount")||t.includes("line")||t.includes("linecount"))&&n.push("people-count"),(t.includes("face")||t.includes("structure"))&&n.push("face-detection"),t.includes("alarm")&&n.push("alarm"),e&&"object"==typeof e){let t=e.Response,o=t&&"object"==typeof t?t.Data:e.Data;if(o&&"object"==typeof o){let e=(e,t,r)=>{let i=o[e];i&&"object"==typeof i&&1===Number(i[r])&&n.push(t)};e("MotionDetection","motion-detection","IsSupportCfg"),e("TamperDetection","tamper-detection","IsSupportCfg"),e("AudioDetection","audio-detection","SupportCfg"),e("HumanShapeDetection","human-shape-detection","SupportCfg"),e("ConflagrationDetection","conflagration-detection","IsSupportCfg");let t=o.TemperatureDetection;t&&"object"==typeof t&&Number(t.SupportTypeNum)>0&&n.push("temperature-detection"),1===Number(o.SupportConflagration)&&n.push("conflagration"),1===Number(o.SupportSmokingDetection)&&n.push("smoking-detection")}}return Array.from(new Set(n))}function a(e,t){if(!e||"object"!=typeof e)return[];for(let n of t){let t=e[n];if(Array.isArray(t))return t.filter(e=>e&&"object"==typeof e)}return[]}n.d(t,{D6:()=>o,HQ:()=>r,I$:()=>a,c6:()=>i})}};var t=require("../../../../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),o=t.X(0,[638,206],()=>n(4020));module.exports=o})();